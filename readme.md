# 20210191项目报告

## 一、个人简单介绍

* 一生一芯学号：20210191
* 姓名：陈子航
* 学校：南京理工大学
* 年级：大三
* 专业：计算机科学与技术
* - [x] 之前是否设计过处理器



## 二、项目情况简单介绍

* - [ ] 是否使用chisel开发

* 代码开源仓库1URL：[https://gitee.com/MaXKev1n/ysyx_210191](https://gitee.com/MaXKev1n/ysyx_210191)
* 代码开源仓库2URL:   [https://gitee.com/MaXKev1n/pipeline_cpu](https://gitee.com/MaXKev1n/pipeline_cpu)

**备注：代码开源仓库1存放Soc提交后的开发文件及记录**

**备注：国庆期间电脑出现故障返修，丢失部分开发文件，备份仅找到7月10日至8月25日的开发记录和文件及9月开发文件，这一部分的开发记录及文件存放于代码开源仓库2;如图所示为备份的部分代码**

<img src="/picture/backup.png" alt="backup" style="zoom:100%;float:left" />




## 三、处理器架构图和模块说明介绍

### 处理器架构图

<img src="/picture/flow1.png" alt="flow1" style="zoom:150%;float:left" />

<img src="/picture/flow2.png" alt="flow2" style="zoom:150%;float:left" />

---

### 模块说明介绍

#### ysyx_210191_pc

1. 接受*ysyx_210191_ctrl*的流水线控制信号
2. 向*ysyx_210191_axi_ctrl*发送指令地址

------

#### ysyx_210191_if

1. 接受*ysyx_210191_ctrl*的流水线控制信号
2. 向*ysyx_210191_axi_ctrl*发送读指令使能
3. 接受*ysyx_210191_axi_ctrl*的指令
4. 向*ysyx_210191_ctrl*发送暂停信号

-----

#### ysyx_210191_if_id

1. 取指阶段和译码阶段的流水线寄存器
2. 接受*ysyx_210191_ctrl*的流水线控制信号
3. 传递指令和指令地址

-------

#### ysyx_210191_decode

1. 接受指令并译码
2. 向后续流水线阶段发送相关指令信号
3. 接受执行阶段和访存阶段的数据
4. 向*ysyx_210191_if_id*和*ysyx_210191_pc*发送跳转指令地址和使能
5. 向*ysyx_210191_ctrl*发送暂停信号

------

#### ysyx_210191_id_exe

1. 接受*ysyx_210191_ctrl*的流水线控制信号
2. 译码阶段和执行阶段的流水线寄存器

------

#### ysyx_210191_exe

1. 进行算术,逻辑,移位等操作

------

#### ysyx_210191_exe_mem

1. 接受*ysyx_210191_ctrl*的流水线控制信号
2. 执行阶段和访存阶段的流水线寄存器

------

#### ysyx_210191_mem

1. 进行访存操作
2. 向*ysyx_210191_clint*进行读写操作
3. 向*ysyx_210191_ctrl*发送暂停信号
4. 向*ysyx_210191_axi_ctrl*发送读写内存使能信号和读写内存地址
5. 接受*ysyx_210191_axi_ctrl*的数据

------

#### ysyx_210191_mem_wb

1. 接受*ysyx_210191_ctrl*的流水线控制信号
2. 访存阶段和写回阶段的流水线寄存器

------

#### ysyx_210191_wb

1. 接受前面流水线的信号
2. 向*ysyx_210191_regfile*发送数据和地址信号

---

#### ysyx_210191_csr

1. 接受时钟中断信号并作出反应
2. 接受前面流水线的写信号
3. 向*ysyx_210191_ctrl*发送mepc地址和中断异常信号

---

#### ysyx_210191_ctrl

1. 接受来自多个模块的暂停信号并向所有流水线寄存器发送控制信号
2. 接受*ysyx_210191_csr*的mepc地址和中断异常信号

----

#### ysyx_210191_clint

1. 接受*ysyx_210191_mem*的写时钟相关寄存器的信号
2. 向*ysyx_210191_mem*发送时钟寄存器的数据

---

#### ysyx_210191_axi_ctrl

1. 接受来自*ysyx_210191_mycpu*的总线相关信号
2. 向*ysyx_210191*发送总线相关信号

---

#### ysyx_210191_mycpu

1. 集成除*ysyx_210191_axi_ctrl*和*ysyx_210191*外所有模块
2. 向*ysyx_210191_axi_ctrl*发送总线相关信号

---

#### ysyx_210191

1. 顶层模块

---



## 四、引用及参考资料

[1] 汪文祥,刑金璋.CPU设计实战[M].北京: 机械工业出版社, 2021

[2] 李亚民.计算机原理与设计:Verilog HDL版[M].北京: 清华大学出版社, 2011



## 五、心得感想

​		本次参加一生一芯让我收获了很多在学校正常学习没法得到的经历，在学校里开发一个硬件项目时，通常没有比较合理和完备的时间安排表和计划，一般是按照自己的经验来进行项目的开发,导致任务分配没有得到合理地安排，出现延期或者质量下降的情况。除此以外，我平时开发项目一般都是个人单独开发一个项目，并没有和他人对接的经历，本次一生一芯和后端同学对接的过程中，和后端同学共同解决处理器在不同环境中出现的问题，让我受益匪浅。同时，过去的开发通常是使用学校提供的如Vivado之类的商业开发工具，本次开发却使用了开源的同类型开发工具，其实现效果与商业软件相比并没有多少差距，让我明白了开源的重要性和便捷性。

​		在这一次开发的过程中，遇到了一些麻烦的bug，主要是由于开发初期的设计混乱，又偏离了助教们制定的计划表。一味地向CPU中添加指令却没有进行功能测试，导致需要在一个阶段中进行大量的debug，同时CPU中产生了大量的冗余的信号。在这过程中遇到的最难调试的bug是在中断异常机制处理的的过程中尝试接入difftest框架时，epc的地址总是出现错误。最坑的bug应该是提交到后端之后连续几天都是未通过测试，最终发现是根据例子编写的AXI总线控制器出现了问题，其自带的的burst功能并没有在verilator测试中出现问题，却在后端测试时出现了问题。最意想不到的bug是一个always块的敏感变量未写全，导致后端测试时寄存器没有进行相应的更改。

​		对于一生一芯的期望，希望明年的时候可以将一些有开发经验的人分配到一个团队中共同开发较复杂的处理器，希望可以在一生一芯中学到团队协作、共同开发处理器的经验。

​		其他想表达的内容就是，希望能够参加下一次的一生一芯，同时能够成为2000个香山的开发者之一。



## 六、测试结果

<img src="/picture/reg-testing.png" alt="cpu-tests" style="zoom:100%;float:left" />

<img src="/picture/rtthread-loader.png" alt="rtthread" style="zoom:100%;float:left" />

